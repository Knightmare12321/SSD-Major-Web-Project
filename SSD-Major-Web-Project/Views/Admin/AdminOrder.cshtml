@model PaginatedList<SSD_Major_Web_Project.ViewModels.OrderVM>

@{
    ViewData["Title"] = "AdminOrder";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="admin-orders" class="active">
        <img id="filter-icon" class="filter-icon" src="~/images/icon/filter-icon.png" />
    <div id="side-bar" class="side-bar">
        <h4>Order Status</h4>
        <ul>
            <li onClick="toggleSummary(this,'','All Orders')">All</li>
            <li onClick="toggleSummary(this,'Pending','Pending Orders')">Pending Payment</li>
            <li onClick="toggleSummary(this,'Paid','Open Orders')" class="active">Open</li>
            <li onClick="toggleSummary(this,'Shipped', 'Shipped Orders')">Shipped</li>
            <li onClick="toggleSummary(this,'Delivered','Delivered Orders')">Delivered</li>
            <li onClick="toggleSummary(this,'Cancelled','Cancelled Orders')">Cancelled</li>


        </ul>
    </div>
    <div>
        <div id="order-sheet" class="summary">
            <input id="sheet-type" value="Paid" hidden/>
            <h1 id="orders-title">Open Orders</h1>
            <div>
                <input id="search-term" placeholder="search text" />
                <button class="btn" onClick="getFilteredAndPaginatedOrders(@Model.PageIndex)">Filter</button>
            </div>
            <span id="message"></span>
            <div id="orders-data">
                @await Html.PartialAsync("../Shared/_OrderSummaryPartial", Model)
            </div>
        </div>
    </div>
</div>


@* Order detail Page Component*@
<div id="admin-order-detail">
    <button class="btn btn-secondary" onclick="closeOrderDetail()">Back</button>
    <table>
        <tr>
            <td>Order Id:</td>
            <td class="id"></td>
        </tr>
        <tr>
            <td>Order Date: </td>
            <td class="date"></td>
        </tr>
        <tr>
            <td>Status: </td>
            <td class="status"></td>
        </tr>
        <tr>
            <td>Buyer: </td>
            <td class="buyer"></td>
        </tr>
        <tr>
            <td>Buyer Note: </td>
            <td class="buyernote"></td>
        </tr>
        <tr>
            <td>Items: </td>
            <td class="items"></td>
        </tr>
        <tr>
            <td>Discount: </td>
            <td class="discount"></td>
        </tr>
        <tr>
            <td>Total: </td>
            <td class="total-price"></td>
        </tr>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        //add onhover event listener to side bar icon and side bar menu to open it up or
        //keep it opened up
        $("#filter-icon").hover(
            function () {
                $('#side-bar').addClass('active');
            }, 
            function () {
                $('#side-bar').removeClass('active') 
            }
        );

        $("#side-bar").hover(
            function () {
                $('#side-bar').addClass('active')
            }, 
            function () { 
                $('#side-bar').removeClass('active') 
            }
        );
    });

    const toggleSummary = (tabClicked, sheetType, sheetTitle) => {
        //reset message element
        $("#message").html("");

        //toggle tabs
        $("#admin-orders li").removeClass("active");
        $(tabClicked).addClass("active");

        //update hidden sheet-type variable
        $("#sheet-type").val(sheetType);

        //toggle order summary sheet
        const url = '@Url.Action("GetFilteredOrders", "Admin")';
        $.ajax({
            type: "GET",
            url: url,
            data: { "orderStatus": sheetType },
            success: function (data) {
                $("#orders-title").html(sheetTitle);
                $("#orders-data").html(data);
            }
        });
    }

    const getFilteredAndPaginatedOrders = (pageIndex) => {
        //reset message element
        $("#message").html("");

        const searchTerm = $("#search-term").val();
        const sheetType = $("#sheet-type").val();
        const url = '@Url.Action("GetFilteredOrders", "Admin")';
        $.ajax({
            type: "GET",
            url: url,
            data: { "orderStatus": sheetType, "searchTerm": searchTerm, "pageIndex": pageIndex },
            success: function (data) {
                $("#orders-data").html(data);
            }
        });
    }

    const dispatchOrder =  (orderId) => {
        //reset message element
        $("#message").html("");

        const url = '@Url.Action("DispatchOrder", "Admin")';
        $.ajax({
            type: "POST",
            url: url,
            data: { orderId },
            success:  function(data) {
                if (data.success) {
                    $("[id^=" + orderId + "]").addClass('dispatched')

                    //update button class, text and order status text
                    $("[id^=" + orderId + "] button:contains(Dispatch)").addClass('deactivated').html('Dispatched')
                    $("[id^=" + orderId + "] td.order-status").html("Shipped");
                    //reset message element
                    $("#message").html("Successfully dispatched order #"+orderId);
                } else {
                    $("#message").html(data.error)
                }
            },
            error: function () {
                $("#message").html("An unexpected error occured")
            }
        });
    }

    const getOrderDetail = (order) => {
        $("#admin-order-detail td.id").html(order.orderId);
        $("#admin-order-detail td.date").html(order.orderDate);
        //get order status from the spreadsheet which has the most up-to-date value from the
        //async actions
        const orderStatus = $("[id^=" + order.orderId + "] td.order-status").html();
        $("#admin-order-detail td.status").html(orderStatus);
        $("#admin-order-detail td.buyer").html(order.contact.firstName + " " + order.contact.lastName);
        $("#admin-order-detail td.buyernote").html(order.buyerNote);
        $("#admin-order-detail td.id").html(order.orderrId);
        const items = order.orderDetails.map(od => {
            const images = od.fkSku.fkProduct.images;
            let listingImage = "";
            if (images.length > 0)
            {
                listingImage = `<img src=data:image;base64,${images[0].data} alt=${images[0].altText}/>`
            }
            return `<div class='item'>
   
                        <div class="img-container">
                        ${listingImage}
                        </div>
                        <div class="item-detail">
                            <div>${od.fkSku.fkProduct.name}</div>
                            <div>
                                <span>Size: ${od.fkSku.size}</span>
                                    <span>Price: $${od.unitPrice}</span>
                                <span>Quantity: ${od.quantity}</span>
                            </div>
                        </div>
                    </div>`;

        });
        $("#admin-order-detail td.items").html(items);
        //also show discount detail if there is one
        if (order.discount) {
            const discountValue = order.discount.discountValue;
            const discountContent = order.discount.discountType.toLowerCase() == 'percent' ? `${discountValue}% off` : `-$${discountValue}`
            $("#admin-order-detail td.discount").html(`${order.discount.pkDiscountCode} (${discountContent})`)
        } else {
            $("#admin-order-detail td.discount").html("None");
        }
        $("#admin-order-detail td.total-price").html(`$${order.orderTotal}`);

        //toggle on detail page
        $("#admin-orders").removeClass("active");
        $("#admin-order-detail").addClass("active");
    }

    const closeOrderDetail = () => {
        $("#admin-order-detail").removeClass("active");
        $("#admin-orders").addClass("active");
    }

    const cancelOrder = (orderId) => {
        //reset message element
        $("#message").html("");

        const url = '@Url.Action("CancelOrder", "Admin")';
        $.ajax({
            type: "POST",
            url: url,
            data: { orderId },
            success: function (data) {
                if (data.success) {
                    $("[id^=" + orderId + "]").addClass('cancelled');

                    //update button class, text and order status text
                    $("[id^=" + orderId + "] button:contains(Cancel)").addClass('deactivated').html('Cancelled');
                    $("[id^=" + orderId + "] td.order-status").html("Cancelled");
                    $("#message").html("Successfully canceled order #"+orderId);
                } else {
                    $("#message").html(data.error);
                }
            },
            error: function (request, status, error) {
                $("#message").html(error);
            }
        });
    }

</script>

