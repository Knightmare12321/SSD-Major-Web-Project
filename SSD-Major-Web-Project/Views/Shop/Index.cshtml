@model SSD_Major_Web_Project.ViewModels.ShoppingCartVM

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="shoppingcart-container">

    <div class="row">
        <h2>My Shopping Bag</h2>
        <div class="col-md-5">
            <div class="shopping-cart">
     
                @foreach (var item in @Model.Products)
                {
                    <div class="product">
                        @if (item.Images != null && item.Images.Count > 0)
                        {
                            <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.Images.FirstOrDefault().Data)" alt="@item.Name" class="product-image" />
                        }
                        <div class="product-details">
                            <p>@item.Name</p>
                            <p>@item.Price</p>
                            @foreach (var cartItem in Model.ShoppingCartItems)
                            {
                                if (cartItem.SkuId == item.ProductSkus.FirstOrDefault().PkSkuId)
                                {
                                    <p>Qty: @cartItem.Quantity</p>
                                    break;
                                }
                            }

                        </div>
                    </div> 
                }
            </div>
            <div class="my-wishlist">
                <h2>My Favourites</h2>
            </div>
        </div>

        <div class="col-md-6 col-md-offset-2">
            <div class="coupon-code">
                <input id="coupon-code" type="text" placeholder="Coupon Code" />
                <button value="Apply Code" class="btn btn-primary" onClick="applyCouponCode()">Apply Discount</button>
            </div>
            <p id="message"></p>
            <div id="discount-section">
                <div>
                    <dt class="col-sm-3">
                        Discount
                    </dt>
                </div>
                <div>
                    <dd class="col-sm-10">
                        <p id="discount"></p>
                    </dd>
                </div>
            </div>
            <div class="shopping-cart-total-form">
                <div>
                    <dt class="col-sm-3">
                        <p>@Html.DisplayNameFor(model => model.Subtotal)</p>
                    </dt>
                </div>
                <div>
                    <dd class="col-sm-10">
@*                         <p id="subtotal">@Html.DisplayFor(model => model.Subtotal)</p>
 *@                        <p id="subtotal">100</p>

                    </dd>
                </div>
             </div>
             <div class="shopping-cart-total-form">
                    <dt class="col-sm-2">
                        <p>@Html.DisplayNameFor(model => model.ShippingFee)</p>
                    </dt>
                    <dd class="col-sm-10">
                        <p>@Html.DisplayFor(model => model.ShippingFee)</p>
                    </dd>
             </div>
             <div class="shopping-cart-total-form">
                    <dt class="col-sm-2">
                        <p>@Html.DisplayNameFor(model => model.Taxes)</p>
                    </dt>
                    <dd class="col-sm-10">
                        <p id="tax">@Html.DisplayFor(model => model.Taxes)</p>
                    </dd>
             </div>
             <div class="shopping-cart-total-form">
                    <dt class="col-sm-2">
                        <p>@Html.DisplayNameFor(model => model.GrandTotal)</p>
                    </dt>
                    <dd class="col-sm-10">
                        <p id="grandtotal">@Html.DisplayFor(model => model.GrandTotal)</p>
                    </dd>
             </div>
   
            <div class="shopping-cart-total-submit">
                <form asp-action="CheckoutShippingContact" asp-controller="Shop" method="post">
                    <input type="hidden" asp-for="@Model.UserId" />
                    @foreach (var item in Model.ShoppingCartItems)
                    {
                        <input type="hidden" name="ShoppingCartItems.SkuId" value="@item.SkuId"/>
                      

                    }
                    <input id="msubtotal" type="hidden" name="Subtotal" value="@Model.Subtotal" />
                    <input type="hidden" name="ShippingFee" value="@Model.ShippingFee" />
                    <input id="mtax" type="hidden" name="Taxes" value="@Model.Taxes" />
                    <input id="mgrand-total" type="hidden" name="GrandTotal" value="@Model.GrandTotal" />  

                    <button type="submit" class="btn btn-primary">Proceed to Checkout</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const applyCouponCode = () => {
        const couponCode = $("#coupon-code").val();
        const url = '@Url.Action("CheckDiscountCode", "Shop")';
        $.ajax({
            type: "GET",
            url: url,
            data: { "couponCode": couponCode},
            success: function (data) {
                console.log(data)
                if (data.success) {
                    const subtotal = parseFloat($("#msubtotal").html());

                    //update order amounts and show discount on screen
                    $("#discount-section").addClass('show');
                    if (data.discountType.toLowerCase() == "percent") {
                        $("#discount").html(`${data.discountValue}% off`);
                        //update subtotal
                        var newSubtotal = (subtotal * (1-data.discountValue/100.0)).toFixed(2);
                        $("#subtotal").html(subtotal + ` <span>${newSubtotal}</span>`).addClass('price-update')
                    } else {
                        $("#discount").html(`$${data.discountValue} off`);
                    }

                }else{
                    $("#message").html(data.error);
                }
            },
            error: function () {
                $("#message").html("An unexpected error occured")
            }
        });
    }
</script>